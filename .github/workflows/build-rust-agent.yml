name: Build Rust Agent

on:
  push:
    branches: [main]
    paths:
      - 'agent-rust/**'
      - '.github/workflows/build-rust-agent.yml'
  pull_request:
    branches: [main]
    paths:
      - 'agent-rust/**'
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  APP_NAME: NetWatch Agent
  APP_VERSION: "1.0.0"

jobs:
  build-windows:
    name: Windows Installer
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            agent-rust/target
          key: windows-cargo-${{ hashFiles('agent-rust/Cargo.lock') }}

      - name: Build release
        working-directory: agent-rust
        run: cargo build --release

      - name: Create installer with Inno Setup
        working-directory: agent-rust
        shell: pwsh
        run: |
          # Create installer script
          @"
          [Setup]
          AppName=NetWatch Agent
          AppVersion=1.0.0
          AppPublisher=NetWatch
          DefaultDirName={autopf}\NetWatch Agent
          DefaultGroupName=NetWatch Agent
          OutputDir=..\installer
          OutputBaseFilename=NetWatch-Agent-Setup-1.0.0-x64
          Compression=lzma
          SolidCompression=yes
          ArchitecturesAllowed=x64compatible
          ArchitecturesInstallIn64BitMode=x64compatible
          PrivilegesRequired=admin
          SetupIconFile=assets\icon.ico
          UninstallDisplayIcon={app}\netwatch-agent.exe

          [Files]
          Source: "target\release\netwatch-agent.exe"; DestDir: "{app}"; Flags: ignoreversion

          [Icons]
          Name: "{group}\NetWatch Agent"; Filename: "{app}\netwatch-agent.exe"
          Name: "{group}\Uninstall NetWatch Agent"; Filename: "{uninstallexe}"
          Name: "{commonstartup}\NetWatch Agent"; Filename: "{app}\netwatch-agent.exe"; Tasks: startup

          [Tasks]
          Name: "startup"; Description: "Start NetWatch Agent when Windows starts"; GroupDescription: "Additional options:"

          [Run]
          Filename: "{app}\netwatch-agent.exe"; Description: "Launch NetWatch Agent"; Flags: nowait postinstall skipifsilent
          "@ | Out-File -FilePath installer.iss -Encoding UTF8

          mkdir ..\installer -ErrorAction SilentlyContinue
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: installer/*.exe
          retention-days: 30

  build-macos:
    name: macOS DMG
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - target: x86_64-apple-darwin
            arch: x64
          - target: aarch64-apple-darwin
            arch: arm64
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            agent-rust/target
          key: macos-${{ matrix.arch }}-cargo-${{ hashFiles('agent-rust/Cargo.lock') }}

      - name: Build release
        working-directory: agent-rust
        run: cargo build --release --target ${{ matrix.target }}

      - name: Create .app bundle
        working-directory: agent-rust
        run: |
          APP_NAME="NetWatch Agent"
          APP_DIR="${APP_NAME}.app"

          mkdir -p "${APP_DIR}/Contents/MacOS"
          mkdir -p "${APP_DIR}/Contents/Resources"

          # Copy binary
          cp "target/${{ matrix.target }}/release/netwatch-agent" "${APP_DIR}/Contents/MacOS/"
          chmod +x "${APP_DIR}/Contents/MacOS/netwatch-agent"

          # Create Info.plist
          cat > "${APP_DIR}/Contents/Info.plist" << 'PLIST'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>netwatch-agent</string>
    <key>CFBundleIdentifier</key>
    <string>com.netwatch.agent</string>
    <key>CFBundleName</key>
    <string>NetWatch Agent</string>
    <key>CFBundleDisplayName</key>
    <string>NetWatch Agent</string>
    <key>CFBundleVersion</key>
    <string>1.0.0</string>
    <key>CFBundleShortVersionString</key>
    <string>1.0.0</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleSignature</key>
    <string>????</string>
    <key>LSMinimumSystemVersion</key>
    <string>10.13</string>
    <key>LSUIElement</key>
    <true/>
    <key>NSHighResolutionCapable</key>
    <true/>
    <key>LSApplicationCategoryType</key>
    <string>public.app-category.utilities</string>
</dict>
</plist>
PLIST

          # Create PkgInfo
          echo -n "APPL????" > "${APP_DIR}/Contents/PkgInfo"

          # Verify app bundle
          echo "App bundle contents:"
          ls -laR "${APP_DIR}"

      - name: Create DMG
        working-directory: agent-rust
        run: |
          APP_NAME="NetWatch Agent"
          DMG_NAME="NetWatch-Agent-1.0.0-${{ matrix.arch }}.dmg"

          # Create a temporary directory for DMG contents
          mkdir -p dmg_contents
          cp -R "${APP_NAME}.app" dmg_contents/

          # Create a symbolic link to /Applications
          ln -s /Applications dmg_contents/Applications

          # Create DMG using hdiutil (more reliable than create-dmg)
          hdiutil create -volname "NetWatch Agent" \
            -srcfolder dmg_contents \
            -ov -format UDBZ \
            "${DMG_NAME}"

          # Verify DMG was created
          echo "Created DMG:"
          ls -la "${DMG_NAME}"

          # Test DMG integrity
          echo "Testing DMG integrity..."
          hdiutil verify "${DMG_NAME}" || echo "Warning: DMG verification had issues"

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg-${{ matrix.arch }}
          path: agent-rust/*.dmg
          retention-days: 30

  build-linux:
    name: Linux Packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxcb1-dev libxrandr-dev libxi-dev \
            libxtst-dev libxdo-dev libssl-dev pkg-config libdbus-1-dev \
            libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev \
            libgtk-3-dev libglib2.0-dev libayatana-appindicator3-dev

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            agent-rust/target
          key: linux-cargo-${{ hashFiles('agent-rust/Cargo.lock') }}

      - name: Build release
        working-directory: agent-rust
        run: cargo build --release

      - name: Create DEB package
        working-directory: agent-rust
        run: |
          mkdir -p deb/DEBIAN
          mkdir -p deb/usr/bin
          mkdir -p deb/etc/systemd/system
          mkdir -p deb/usr/share/applications

          cp target/release/netwatch-agent deb/usr/bin/
          chmod +x deb/usr/bin/netwatch-agent

          # Control file
          cat > deb/DEBIAN/control << 'EOF'
          Package: netwatch-agent
          Version: 1.0.0
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: NetWatch <support@netwatch.com>
          Description: NetWatch Monitoring Agent
           A lightweight monitoring agent for employee activity tracking.
          EOF

          # Systemd service
          cat > deb/etc/systemd/system/netwatch-agent.service << 'EOF'
          [Unit]
          Description=NetWatch Monitoring Agent
          After=network.target

          [Service]
          Type=simple
          ExecStart=/usr/bin/netwatch-agent
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          EOF

          # Desktop file
          cat > deb/usr/share/applications/netwatch-agent.desktop << 'EOF'
          [Desktop Entry]
          Name=NetWatch Agent
          Comment=NetWatch Monitoring Agent
          Exec=/usr/bin/netwatch-agent
          Terminal=false
          Type=Application
          Categories=Utility;
          EOF

          # Post-install script
          cat > deb/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          systemctl daemon-reload
          systemctl enable netwatch-agent
          systemctl start netwatch-agent
          EOF
          chmod +x deb/DEBIAN/postinst

          # Build DEB
          dpkg-deb --build deb netwatch-agent-1.0.0-amd64.deb

      - name: Create AppImage
        working-directory: agent-rust
        run: |
          # Download appimagetool
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          # Create AppDir
          mkdir -p AppDir/usr/bin
          cp target/release/netwatch-agent AppDir/usr/bin/

          # Desktop file
          cat > AppDir/netwatch-agent.desktop << 'EOF'
          [Desktop Entry]
          Name=NetWatch Agent
          Exec=netwatch-agent
          Icon=netwatch-agent
          Type=Application
          Categories=Utility;
          EOF

          # AppRun
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          exec "${HERE}/usr/bin/netwatch-agent" "$@"
          EOF
          chmod +x AppDir/AppRun

          # Create simple icon (placeholder)
          convert -size 256x256 xc:navy AppDir/netwatch-agent.png 2>/dev/null || touch AppDir/netwatch-agent.png

          # Build AppImage
          ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir NetWatch-Agent-1.0.0-x86_64.AppImage || true

      - name: Upload Linux packages
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            agent-rust/*.deb
            agent-rust/*.AppImage
          retention-days: 30

  release:
    name: Create Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: find artifacts -type f -name "*"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: rust-agent-v1.0.0-${{ github.run_number }}
          name: NetWatch Rust Agent v1.0.0 (Build ${{ github.run_number }})
          body: |
            ## NetWatch Rust Agent v1.0.0

            ### Downloads

            | Platform | File | Description |
            |----------|------|-------------|
            | **Windows** | `NetWatch-Agent-Setup-1.0.0-x64.exe` | Installer with auto-start option |
            | **macOS Intel** | `NetWatch-Agent-1.0.0-x64.dmg` | Drag & drop installer |
            | **macOS Apple Silicon** | `NetWatch-Agent-1.0.0-arm64.dmg` | Drag & drop installer |
            | **Linux** | `netwatch-agent-1.0.0-amd64.deb` | Debian/Ubuntu package |
            | **Linux** | `NetWatch-Agent-1.0.0-x86_64.AppImage` | Portable AppImage |

            ### Installation

            **Windows:** Run the installer and follow the prompts.

            **macOS:** Open the DMG and drag NetWatch Agent to Applications.

            **Linux (Debian/Ubuntu):**
            ```bash
            sudo dpkg -i netwatch-agent-1.0.0-amd64.deb
            ```

            **Linux (AppImage):**
            ```bash
            chmod +x NetWatch-Agent-1.0.0-x86_64.AppImage
            ./NetWatch-Agent-1.0.0-x86_64.AppImage
            ```

            ### Server
            Pre-configured to connect to: `https://do.roydevelops.tech/nw-socket`
          files: |
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.deb
            artifacts/**/*.AppImage
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
